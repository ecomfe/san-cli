<!doctype html><html><head><meta charset="utf-8"/><title>San CLI</title><link rel="icon" href="/san-cli/favicon.ico"><script>window['SAN_DOCIT'] = {};</script><base href="/san-cli/"><link href="/san-cli/static/css/chunk-vendors.css" rel="stylesheet"><link href="/san-cli/static/css/client-entry.css" rel="stylesheet"></head><body><div id="app"><div id="site"><header id="header"><a href="/san-cli/" class="navbar"><img src="/san-cli/logo.svg" alt="Home" class="logo"> <span>San CLI</span></a><ul><li><a target="_blank" href="https://baidu.github.io/san/">San</a></li><li><a target="_blank" href="https://ecomfe.github.io/santd/">Santd</a></li><li><a target="_blank" href="https://github.com/ecomfe/eslint-plugin-san">Github</a></li></ul></header><aside id="sidebar" class="sidebar"><ul class="tree"><li data-id="/"><a href="/san-cli/" onclick="return false;">介绍</a></li><li><span>基础命令</span><ul><li data-id="/create-project/"><a href="/san-cli/create-project/" onclick="return false;">初始化项目</a></li><li data-id="/serve/"><a href="/san-cli/serve/" onclick="return false;">开发打包</a></li><li data-id="/build/"><a href="/san-cli/build/" onclick="return false;">生产打包</a></li></ul></li><li><span>配置</span><ul><li data-id="/config/"><a href="/san-cli/config/" onclick="return false;">San CLI 配置文件</a></li><li data-id="/advanced/"><a href="/san-cli/advanced/" onclick="return false;">高级配置</a></li><li data-id="/presets/"><a href="/san-cli/presets/" onclick="return false;">Presets 预设</a></li><li data-id="/env/"><a href="/san-cli/env/" onclick="return false;">环境变量</a></li></ul></li><li><span>常见解决方案</span><ul><li data-id="/modern-mode/"><a href="/san-cli/modern-mode/" onclick="return false;">现在的浏览器打包模式</a></li><li data-id="/bundle-analyze/"><a href="/san-cli/bundle-analyze/" onclick="return false;">Bundle 分析</a></li><li data-id="/component/"><a href="/san-cli/component/" onclick="return false;">San Component 组件开发</a></li><li data-id="/smarty/"><a href="/san-cli/smarty/" onclick="return false;">Smarty 相关</a></li><li data-id="/deployment/"><a href="/san-cli/deployment/" onclick="return false;">部署</a></li><li data-id="/hulk-cli-migration/"><a href="/san-cli/hulk-cli-migration/" onclick="return false;">hulk-cli升级san-cli</a></li></ul></li><li><span>二次开发</span><ul><li data-id="/architecture/"><a href="/san-cli/architecture/" onclick="return false;">内部实现</a></li><li data-id="/create-scaffold/"><a href="/san-cli/create-scaffold/" onclick="return false;">如何创建一个脚手架项目</a></li><li data-id="/plugin/"><a href="/san-cli/plugin/" onclick="return false;">插件</a><ul><li data-id="/cmd-plugin/"><a href="/san-cli/cmd-plugin/" onclick="return false;">Command 插件</a></li><li data-id="/srv-plugin/"><a href="/san-cli/srv-plugin/" onclick="return false;">编写一个 Serivce 插件</a></li></ul></li></ul></li><li><span>CLI UI</span><ul><li data-id="/ui/start/"><a href="/san-cli/ui/start/" onclick="return false;">San CLI UI</a></li><li><span>功能简介</span><ul><li data-id="/ui/project-list/"><a href="/san-cli/ui/project-list/" onclick="return false;">项目管理</a></li><li data-id="/ui/dashboard/"><a href="/san-cli/ui/dashboard/" onclick="return false;">工具扩展</a></li><li data-id="/ui/plugin/"><a href="/san-cli/ui/plugin/" onclick="return false;">插件管理</a></li><li data-id="/ui/dependency/"><a href="/san-cli/ui/dependency/" onclick="return false;">依赖管理与插件管理</a></li><li data-id="/ui/configuration/"><a href="/san-cli/ui/configuration/" onclick="return false;">配置管理</a></li><li data-id="/ui/task/"><a href="/san-cli/ui/task/" onclick="return false;">任务管理</a></li></ul></li><li><span>插件开发</span><ul><li data-id="/ui/structure/"><a href="/san-cli/ui/structure/" onclick="return false;">San CLI UI 工作流程</a></li><li data-id="/ui/plugin-object/"><a href="/san-cli/ui/plugin-object/" onclick="return false;">插件对象</a></li><li data-id="/ui/add-addon/"><a href="/san-cli/ui/add-addon/" onclick="return false;">widget部件</a></li><li data-id="/ui/add-config/"><a href="/san-cli/ui/add-config/" onclick="return false;">添加项目配置</a></li><li data-id="/ui/cover-task/"><a href="/san-cli/ui/cover-task/" onclick="return false;">更改项目任务</a></li><li data-id="/ui/add-view/"><a href="/san-cli/ui/add-view/" onclick="return false;">添加自定义视图</a></li><li data-id="/ui/static/"><a href="/san-cli/ui/static/" onclick="return false;">公共静态文件</a></li></ul></li></ul></li></ul></aside><article id="content"><div id="router-view" class="router-view"><div class="content"><div class="markdown"><h1 id="%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA-serivce-%E6%8F%92%E4%BB%B6"><a class="header-anchor" href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA-serivce-%E6%8F%92%E4%BB%B6">#</a> 编写一个 Serivce 插件</h1><p>San CLI 在实现可扩展 Webpack 配置的设计上，借鉴了 Vue CLI 的 Service 机制。Service 主要是对 Webpack 的配置进行统一处理和封装，当 Service 实例化之时，会依次将 Service 的插件进行注册执行，对 Webpack 的配置进行修改。</p><p>一个 Service 插件的定义结构如下：</p><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 插件 id</span>
    id<span class="token operator">:</span> <span class="token string">&#39;plugin-id&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 插件的入口函数</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> projectOptions<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">chainWebpack</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projectOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            webpackConfig<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// gui 预留接口</span>
    <span class="token function">ui</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="%E6%8F%92%E4%BB%B6%E7%9A%84apply%E5%87%BD%E6%95%B0"><a class="header-anchor" href="#%E6%8F%92%E4%BB%B6%E7%9A%84apply%E5%87%BD%E6%95%B0">#</a> 插件的<code>apply</code>函数</h2><p>插件的<code>apply</code>函数接受三个参数：</p><ol><li><code>api</code>是 PluginAPI 实例，会提供一些 api（下面详细介绍）；</li><li><code>projectOptions</code>是 san.config.js 处理后的项目配置；</li><li><code>options</code> 是插件自己的参数，使用插件时：</li></ol><pre class="language-js"><code class="language-js"><span class="token comment">// san.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token function">requie</span><span class="token punctuation">(</span><span class="token string">&#39;plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>options<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 或者使用 service addPlugin</span>
serviceInstance<span class="token punctuation">.</span><span class="token function">addPlugin</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>在插件中，可以直接使用<code>__isProduction</code>变量，代表是否为<code>mode===&#39;production&#39;</code>，即生产环境打包。</p></blockquote><h2 id="%E5%9C%A8%E6%8F%92%E4%BB%B6%E5%86%85%E4%BF%AE%E6%94%B9-webpack-%E9%85%8D%E7%BD%AE"><a class="header-anchor" href="#%E5%9C%A8%E6%8F%92%E4%BB%B6%E5%86%85%E4%BF%AE%E6%94%B9-webpack-%E9%85%8D%E7%BD%AE">#</a> 在插件内修改 Webpack 配置</h2><p>在插件内有两种方法可以修改 Webpack 配置：</p><ol><li>通过<code>api.chainWebpack</code>获取<a href="https://github.com/neutrinojs/webpack-chain" target="_blank">webpack-chain</a>链式调用的对象，然后进行 Webpack 配置；</li><li>通过<code>api.configWebpack</code>获取对象形式的 Webpack Config。</li></ol><p>例如：</p><pre class="language-js"><code class="language-js">api<span class="token punctuation">.</span><span class="token function">chainWebpack</span><span class="token punctuation">(</span><span class="token parameter">webpackChain</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projectOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    webpackChain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

api<span class="token punctuation">.</span><span class="token function">configWebpack</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>projectOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><a class="header-anchor" href="#%E6%8F%92%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8">#</a> 插件的使用</h2><p>插件可以发布到 npm 上，命名规范建议使用<code>san-cli-plugin-*</code>来命名。不发布到 npm 中也可以本地使用。Service 插件的使用有两种配置方法：</p><ol><li>在<code>san.config.js</code>的 plugins 字段添加对应的路径或者直接<code>require</code>进来；</li><li>在项目的<code>package.json</code>的<code>san.plugins</code>中添加路径或者 npm 插件包名</li></ol><p>san.config.js 中举例：</p><pre class="language-js"><code class="language-js"><span class="token comment">// san.config.js 文件</span>

<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// 这个是直接手写的 plugin</span>
    <span class="token punctuation">{</span>
        id<span class="token operator">:</span> <span class="token string">&#39;smarty-middleware&#39;</span><span class="token punctuation">,</span>
        <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">api</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            api<span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;hulk-mock-server&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./&#39;</span> <span class="token operator">+</span> outputDir <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    rootDir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./mock&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    processors<span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">smarty?router=/template/*&amp;baseDir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
                            __dirname<span class="token punctuation">,</span>
                            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>outputDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/template</span><span class="token template-punctuation string">`</span></span>
                        <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;dataDir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./mock/_data_&#39;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">]</span> <span class="token comment">// eslint-disable-line</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// require进来</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;san-cli-plugin-x&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 这个是相对路径</span>
    <span class="token string">&#39;./san-plugin&#39;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token comment">// 添加插件配置</span>
    plugins
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="service-%E6%8F%92%E4%BB%B6-api"><a class="header-anchor" href="#service-%E6%8F%92%E4%BB%B6-api">#</a> Service 插件 API</h2><p>属性：</p><ul><li><code>.id</code>：插件 id；</li><li><code>.service</code>：service 实例；</li><li><code>.log/logger</code>：日志对象，包含：<ul><li>debug</li><li>done</li><li>error</li><li>warn</li><li>log</li><li>fatal</li><li>trace</li><li>time</li><li>timeEnd</li><li>textColor</li><li>bgColor 等；</li></ul></li><li><code>.version</code>：San CLI 版本号。</li></ul><p>常见方法包括：</p><ul><li><code>.isProd()</code>：是不是生产环境打包，<code>process.NODD_ENV===&#39;production&#39;</code>；</li><li><code>.configWebpack(fn)</code>：将<code>fn</code> 压入 webpackConfig 回调栈，<code>fn</code>会在出栈执行时接收 webpackConfig，用于修改 webpack config；</li><li><code>.chainWebpack(fn)</code>：将<code>fn</code> 压入 webpackChain 回调栈，<code>fn</code>会在出栈执行时接收 chainableConfig，用于 webpack-chain 语法修改 webpack config；</li><li><code>.resolve(p)</code>：获取 CLI 执行目录的完整路径；</li><li><code>.getWebpackChainConfig()</code>：获取 webpack-chain 格式的 config；</li><li><code>.getWebpackConfig([chainableConfig])</code>：将传入的 webpack-chain 格式 config 处理成 webpackConfig 返回；</li><li><code>.getCwd()</code>：获取 CLI 的执行目录；</li><li><code>.getProjectOption()</code>：获取项目的配置内容；</li><li><code>.getPkg()</code>：获取当前项目<code>package.json</code>内容；</li><li><code>.addPlugin(plugin, options)</code>：添加插件；</li><li><code>.middleware()</code>：添加 dev-server 中间件，<strong>这里注意：中间件需要使用 factory 函数返回</strong></li></ul><p><strong><code>.middleware()</code>示例：</strong></p><pre class="language-js"><code class="language-js">api<span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token comment">// return 一个 Expressjs 中间件</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;hulk-mock-server&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./&#39;</span> <span class="token operator">+</span> outputDir <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        rootDir<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;./mock&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        processors<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">smarty?router=/template/*&amp;baseDir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>outputDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/template</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;dataDir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
                __dirname<span class="token punctuation">,</span>
                <span class="token string">&#39;./mock/_data_&#39;</span>
            <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">]</span> <span class="token comment">// eslint-disable-line</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>详细的使用方法可以查看<code>san-cli-plugin-progress</code>的代码。</p></blockquote></div></div></div><aside class="toc"><ul class="tree"></ul></aside></article></div></div><script src="/san-cli/static/js/chunk-vendors.js"></script><script src="/san-cli/static/js/client-entry.js"></script></body></html>